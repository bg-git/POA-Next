{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/POA%20Next/apps/storefront/src/lib/cookies.ts"],"sourcesContent":["export const COOKIE_NAME = 'customer_session';\r\nexport const COOKIE_MAX_AGE = 60 * 60 * 24 * 30; // 30 days in seconds\r\nconst COOKIE_DOMAIN =\r\n  process.env.NEXT_PUBLIC_AUTH_COOKIE_DOMAIN || '.pierceofart.co.uk';\r\n\r\nexport function setCustomerCookie(res: any, token: string) {\r\n  const expires = new Date(Date.now() + COOKIE_MAX_AGE * 1000);\r\n  const cookie = `${COOKIE_NAME}=${encodeURIComponent(\r\n    token,\r\n  )}; Path=/; SameSite=None; Max-Age=${COOKIE_MAX_AGE}; Expires=${expires.toUTCString()}; Domain=${COOKIE_DOMAIN}; Secure`;\r\n  res.setHeader('Set-Cookie', cookie);\r\n}\r\n\r\nexport function clearCustomerCookie(res: any) {\r\n  const cookie = `${COOKIE_NAME}=; Path=/; SameSite=None; Max-Age=0; Domain=${COOKIE_DOMAIN}; Secure`;\r\n  res.setHeader('Set-Cookie', cookie);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAO,MAAM,cAAc;AACpB,MAAM,iBAAiB,KAAK,KAAK,KAAK,IAAI,qBAAqB;AACtE,MAAM,gBACJ,QAAQ,GAAG,CAAC,8BAA8B,IAAI;AAEzC,SAAS,kBAAkB,GAAQ,EAAE,KAAa;IACvD,MAAM,UAAU,IAAI,KAAK,KAAK,GAAG,KAAK,iBAAiB;IACvD,MAAM,SAAS,GAAG,YAAY,CAAC,EAAE,mBAC/B,OACA,iCAAiC,EAAE,eAAe,UAAU,EAAE,QAAQ,WAAW,GAAG,SAAS,EAAE,cAAc,QAAQ,CAAC;IACxH,IAAI,SAAS,CAAC,cAAc;AAC9B;AAEO,SAAS,oBAAoB,GAAQ;IAC1C,MAAM,SAAS,GAAG,YAAY,4CAA4C,EAAE,cAAc,QAAQ,CAAC;IACnG,IAAI,SAAS,CAAC,cAAc;AAC9B"}},
    {"offset": {"line": 36, "column": 0}, "map": {"version":3,"sources":["file:///C:/POA%20Next/apps/storefront/src/pages/api/shopify/verify-customer.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\r\nimport { COOKIE_NAME, setCustomerCookie } from '@/lib/cookies';\r\n\r\nconst SHOPIFY_DOMAIN = process.env.SHOPIFY_STORE_DOMAIN!;\r\nconst STOREFRONT_TOKEN = process.env.SHOPIFY_STOREFRONT_ACCESS_TOKEN!;\r\nconst STOREFRONT_URL = `https://${SHOPIFY_DOMAIN}/api/2024-04/graphql.json`;\r\nconst ADMIN_API_KEY = process.env.SHOPIFY_ADMIN_API_KEY!;\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ success: false, error: 'Method not allowed' });\r\n  }\r\n\r\n  const token = req.cookies[COOKIE_NAME];\r\n\r\n  if (!token) {\r\n    return res.status(401).json({ success: false, error: 'Not authenticated' });\r\n  }\r\n\r\n  const query = `\r\n      query customer($customerAccessToken: String!) {\r\n        customer(customerAccessToken: $customerAccessToken) {\r\n          id\r\n          firstName\r\n          lastName\r\n          email\r\n          phone\r\n          acceptsMarketing\r\n          createdAt\r\n          updatedAt\r\n        }\r\n      }\r\n  `;\r\n\r\n  const variables = {\r\n    customerAccessToken: token,\r\n  };\r\n\r\n  try {\r\n    const response = await fetch(STOREFRONT_URL, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-Shopify-Storefront-Access-Token': STOREFRONT_TOKEN,\r\n      },\r\n      body: JSON.stringify({ query, variables }),\r\n    });\r\n\r\n    const json = await response.json();\r\n\r\n    if (json.errors || !json.data.customer) {\r\n      return res.status(401).json({ success: false, error: 'Invalid token' });\r\n    }\r\n\r\n    const customer = json.data.customer;\r\n\r\n    let tags: string[] = [];\r\n    if (customer.email) {\r\n      const adminRes = await fetch(`https://${SHOPIFY_DOMAIN}/admin/api/2023-01/customers/search.json?query=email:${encodeURIComponent(customer.email)}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'X-Shopify-Access-Token': ADMIN_API_KEY,\r\n        },\r\n      });\r\n      const adminJson = await adminRes.json();\r\n      if (adminJson.customers && adminJson.customers.length > 0) {\r\n        const adminCustomer = adminJson.customers[0];\r\n        if (adminCustomer.tags) {\r\n          tags = adminCustomer.tags.split(',').map((t: string) => t.trim()).filter(Boolean);\r\n        }\r\n      }\r\n    }\r\n\r\n    setCustomerCookie(res, token);\r\n    return res.status(200).json({\r\n      success: true,\r\n      customer: {\r\n        ...customer,\r\n        tags,\r\n      },\r\n    });\r\n  } catch (error: unknown) {\r\n    const message = error instanceof Error ? error.message : 'An unknown error occurred';\r\n    return res.status(500).json({ success: false, error: message });\r\n  }\r\n} "],"names":[],"mappings":";;;;AACA;;AAEA,MAAM,iBAAiB,QAAQ,GAAG,CAAC,oBAAoB;AACvD,MAAM,mBAAmB,QAAQ,GAAG,CAAC,+BAA+B;AACpE,MAAM,iBAAiB,CAAC,QAAQ,EAAE,eAAe,yBAAyB,CAAC;AAC3E,MAAM,gBAAgB,QAAQ,GAAG,CAAC,qBAAqB;AAExC,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAqB;IAC5E;IAEA,MAAM,QAAQ,IAAI,OAAO,CAAC,mJAAW,CAAC;IAEtC,IAAI,CAAC,OAAO;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAoB;IAC3E;IAEA,MAAM,QAAQ,CAAC;;;;;;;;;;;;;EAaf,CAAC;IAED,MAAM,YAAY;QAChB,qBAAqB;IACvB;IAEA,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,gBAAgB;YAC3C,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,qCAAqC;YACvC;YACA,MAAM,KAAK,SAAS,CAAC;gBAAE;gBAAO;YAAU;QAC1C;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,IAAI,KAAK,MAAM,IAAI,CAAC,KAAK,IAAI,CAAC,QAAQ,EAAE;YACtC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAgB;QACvE;QAEA,MAAM,WAAW,KAAK,IAAI,CAAC,QAAQ;QAEnC,IAAI,OAAiB,EAAE;QACvB,IAAI,SAAS,KAAK,EAAE;YAClB,MAAM,WAAW,MAAM,MAAM,CAAC,QAAQ,EAAE,eAAe,qDAAqD,EAAE,mBAAmB,SAAS,KAAK,GAAG,EAAE;gBAClJ,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,0BAA0B;gBAC5B;YACF;YACA,MAAM,YAAY,MAAM,SAAS,IAAI;YACrC,IAAI,UAAU,SAAS,IAAI,UAAU,SAAS,CAAC,MAAM,GAAG,GAAG;gBACzD,MAAM,gBAAgB,UAAU,SAAS,CAAC,EAAE;gBAC5C,IAAI,cAAc,IAAI,EAAE;oBACtB,OAAO,cAAc,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAc,EAAE,IAAI,IAAI,MAAM,CAAC;gBAC3E;YACF;QACF;QAEA,IAAA,yJAAiB,EAAC,KAAK;QACvB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,SAAS;YACT,UAAU;gBACR,GAAG,QAAQ;gBACX;YACF;QACF;IACF,EAAE,OAAO,OAAgB;QACvB,MAAM,UAAU,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACzD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAQ;IAC/D;AACF"}}]
}