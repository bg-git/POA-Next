{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/POA%20Next/apps/storefront/src/pages/api/booking/availability.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from 'next';\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || '';\r\nconst supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || '';\r\nconst supabase = createClient(supabaseUrl, supabaseKey);\r\n\r\ninterface TimeSlot {\r\n  start_time: string;\r\n  formatedTime: string;\r\n  slots: number;\r\n}\r\n\r\ninterface Availability {\r\n  date: string;\r\n  available: boolean;\r\n  spots: TimeSlot[];\r\n}\r\n\r\nconst LOCATION_MAP: Record<string, string> = {\r\n  chesterfield: 'Chesterfield',\r\n  leicester: 'Leicester',\r\n};\r\n\r\nconst OPERATING_HOURS = [\r\n  { time: '09:00 AM', slots: 2 },\r\n  { time: '10:00 AM', slots: 2 },\r\n  { time: '11:00 AM', slots: 2 },\r\n  { time: '02:00 PM', slots: 2 },\r\n  { time: '03:00 PM', slots: 2 },\r\n  { time: '04:00 PM', slots: 1 },\r\n];\r\n\r\nexport default async function handler(\r\n  req: NextApiRequest,\r\n  res: NextApiResponse\r\n) {\r\n  if (req.method !== 'GET') {\r\n    return res.status(405).json({ error: 'Method not allowed' });\r\n  }\r\n\r\n  const { location } = req.query;\r\n\r\n  if (!location || typeof location !== 'string') {\r\n    return res.status(400).json({ error: 'Location parameter required' });\r\n  }\r\n\r\n  if (!LOCATION_MAP[location]) {\r\n    return res.status(400).json({ error: 'Invalid location' });\r\n  }\r\n\r\n  try {\r\n    const locationName = LOCATION_MAP[location];\r\n    const availabilities: Availability[] = [];\r\n\r\n    // Generate 30 days from today\r\n    for (let i = 0; i < 30; i++) {\r\n      const date = new Date();\r\n      date.setDate(date.getDate() + i);\r\n\r\n      // Skip Sundays\r\n      if (date.getDay() === 0) continue;\r\n\r\n      const dateStr = date.toISOString().split('T')[0];\r\n\r\n      // Get booked slots for this date\r\n      const { data: bookings, error: fetchError } = await supabase\r\n        .from('bookings')\r\n        .select('appointment_time, slots_booked')\r\n        .eq('location', locationName)\r\n        .eq('appointment_date', dateStr)\r\n        .eq('status', 'confirmed');\r\n\r\n      if (fetchError) throw fetchError;\r\n\r\n      // Calculate available slots per time\r\n      const bookedByTime: Record<string, number> = {};\r\n      if (bookings) {\r\n        bookings.forEach((booking) => {\r\n          bookedByTime[booking.appointment_time] =\r\n            (bookedByTime[booking.appointment_time] || 0) + (booking.slots_booked || 1);\r\n        });\r\n      }\r\n\r\n      const spots: TimeSlot[] = OPERATING_HOURS.map((hour) => ({\r\n        start_time: hour.time,\r\n        formatedTime: hour.time,\r\n        slots: hour.slots - (bookedByTime[hour.time] || 0),\r\n      })).filter((slot) => slot.slots > 0);\r\n\r\n      availabilities.push({\r\n        date: dateStr,\r\n        available: spots.length > 0,\r\n        spots,\r\n      });\r\n    }\r\n\r\n    return res.status(200).json({\r\n      success: true,\r\n      location: locationName,\r\n      availabilities,\r\n    });\r\n  } catch (error) {\r\n    console.error('Availability fetch error:', error);\r\n    return res.status(500).json({\r\n      error: 'Failed to fetch availability',\r\n      details: error instanceof Error ? error.message : '',\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM,cAAc,gFAAwC;AAC5D,MAAM,cAAc,QAAQ,GAAG,CAAC,yBAAyB,IAAI;AAC7D,MAAM,WAAW,IAAA,iKAAY,EAAC,aAAa;AAc3C,MAAM,eAAuC;IAC3C,cAAc;IACd,WAAW;AACb;AAEA,MAAM,kBAAkB;IACtB;QAAE,MAAM;QAAY,OAAO;IAAE;IAC7B;QAAE,MAAM;QAAY,OAAO;IAAE;IAC7B;QAAE,MAAM;QAAY,OAAO;IAAE;IAC7B;QAAE,MAAM;QAAY,OAAO;IAAE;IAC7B;QAAE,MAAM;QAAY,OAAO;IAAE;IAC7B;QAAE,MAAM;QAAY,OAAO;IAAE;CAC9B;AAEc,eAAe,QAC5B,GAAmB,EACnB,GAAoB;IAEpB,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAqB;IAC5D;IAEA,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,KAAK;IAE9B,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU;QAC7C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA8B;IACrE;IAEA,IAAI,CAAC,YAAY,CAAC,SAAS,EAAE;QAC3B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAmB;IAC1D;IAEA,IAAI;QACF,MAAM,eAAe,YAAY,CAAC,SAAS;QAC3C,MAAM,iBAAiC,EAAE;QAEzC,8BAA8B;QAC9B,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,IAAK;YAC3B,MAAM,OAAO,IAAI;YACjB,KAAK,OAAO,CAAC,KAAK,OAAO,KAAK;YAE9B,eAAe;YACf,IAAI,KAAK,MAAM,OAAO,GAAG;YAEzB,MAAM,UAAU,KAAK,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAEhD,iCAAiC;YACjC,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SACjD,IAAI,CAAC,YACL,MAAM,CAAC,kCACP,EAAE,CAAC,YAAY,cACf,EAAE,CAAC,oBAAoB,SACvB,EAAE,CAAC,UAAU;YAEhB,IAAI,YAAY,MAAM;YAEtB,qCAAqC;YACrC,MAAM,eAAuC,CAAC;YAC9C,IAAI,UAAU;gBACZ,SAAS,OAAO,CAAC,CAAC;oBAChB,YAAY,CAAC,QAAQ,gBAAgB,CAAC,GACpC,CAAC,YAAY,CAAC,QAAQ,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,YAAY,IAAI,CAAC;gBAC9E;YACF;YAEA,MAAM,QAAoB,gBAAgB,GAAG,CAAC,CAAC,OAAS,CAAC;oBACvD,YAAY,KAAK,IAAI;oBACrB,cAAc,KAAK,IAAI;oBACvB,OAAO,KAAK,KAAK,GAAG,CAAC,YAAY,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC;gBACnD,CAAC,GAAG,MAAM,CAAC,CAAC,OAAS,KAAK,KAAK,GAAG;YAElC,eAAe,IAAI,CAAC;gBAClB,MAAM;gBACN,WAAW,MAAM,MAAM,GAAG;gBAC1B;YACF;QACF;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,SAAS;YACT,UAAU;YACV;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD;IACF;AACF"}}]
}