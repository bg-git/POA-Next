{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/POA%20Next/apps/storefront/src/components/CartDrawer.tsx"],"sourcesContent":["import { useCart, type CartItem } from '@/context/CartContext';\r\nimport Image from 'next/image';\r\nimport { useEffect, useState } from 'react';\r\nimport { useFavourites } from '@/context/FavouritesContext';\r\nimport { useAuth } from '@/context/AuthContext';\r\n\r\nconst formatPrice = (price: string | number | undefined) => {\r\n  const num = typeof price === 'number' ? price : parseFloat(price || '0');\r\n  return num % 1 === 0 ? num.toFixed(0) : num.toFixed(2);\r\n};\r\n\r\nconst getCurrencySymbol = (currencyCode?: string) => {\r\n  const symbols: Record<string, string> = {\r\n    GBP: '£',\r\n    USD: '$',\r\n    CAD: 'CA$',\r\n    EUR: '€',\r\n  };\r\n  \r\n  return symbols[currencyCode || 'GBP'] || '£';\r\n};\r\n\r\nconst displayTitle = (title?: string, variantTitle?: string) => {\r\n  const t = (s?: string) => (s || '').trim();\r\n  const isDefault = (s?: string) => /^default\\s*title$/i.test(s || '');\r\n  const base = t(title);\r\n  const variant = t(variantTitle);\r\n  if (!variant || isDefault(variant) || variant.toLowerCase() === base.toLowerCase()) {\r\n    return base || 'Untitled Product';\r\n  }\r\n  return `${base} | ${variant}`;\r\n};\r\n\r\nexport default function CartDrawer() {\r\n  const {\r\n    cartItems,\r\n    checkoutUrl,\r\n    isDrawerOpen,\r\n    closeDrawer,\r\n    updateQuantity,\r\n    flushSync,\r\n    draftCheckoutUrl,\r\n    draftStatus,\r\n    ensureVipDraftCheckout,\r\n  } = useCart();\r\n\r\n  const { addFavourite } = useFavourites();\r\n\r\n  const { user } = useAuth();\r\n  const isVipMember = Array.isArray(user?.tags)\r\n    ? user.tags.includes('VIP-MEMBER')\r\n    : false;\r\n\r\n  const parsePrice = (value?: string) => {\r\n    const trimmed = value?.trim();\r\n    if (!trimmed) return null;\r\n    const parsed = parseFloat(trimmed);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n  };\r\n\r\n  const getEffectivePrice = (\r\n    itemPrice: Pick<CartItem, 'basePrice' | 'memberPrice' | 'price'>\r\n  ) => {\r\n    const base =\r\n      parsePrice(itemPrice.basePrice) ?? parsePrice(itemPrice.price) ?? 0;\r\n    const member = parsePrice(itemPrice.memberPrice);\r\n\r\n    if (isVipMember && member !== null) return member;\r\n    return base;\r\n  };\r\n\r\n  const [isCheckingOut, setIsCheckingOut] = useState(false);\r\n  const isDraftBuilding = isVipMember && draftStatus === 'building';\r\n  const checkoutLabel = isVipMember ? 'CHECKOUT' : 'CHECKOUT';\r\n\r\n\r\n  useEffect(() => {\r\n    const handleEscape = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') closeDrawer();\r\n    };\r\n\r\n    if (isDrawerOpen) {\r\n      document.addEventListener('keydown', handleEscape);\r\n    }\r\n\r\n    return () => {\r\n      document.removeEventListener('keydown', handleEscape);\r\n    };\r\n  }, [isDrawerOpen, closeDrawer]);\r\n\r\n  return (\r\n  <div\r\n  className={`cart-backdrop${isDrawerOpen ? ' open' : ''}`}\r\n  onMouseDown={(e) => {\r\n    if (e.target === e.currentTarget) {\r\n      closeDrawer()\r\n    }\r\n  }}\r\n>\r\n\r\n      <div\r\n        className={`cart-drawer${isDrawerOpen ? ' open' : ''}`}\r\n        role=\"dialog\"\r\n        aria-modal=\"true\"\r\n        aria-labelledby=\"cart-drawer-title\"\r\n        onClick={(e) => e.stopPropagation()}\r\n      >\r\n        <div className=\"cart-drawer-inner\">\r\n          <div className=\"cart-header\">\r\n            <h2 id=\"cart-drawer-title\">MY BAG</h2>\r\n            <button onClick={closeDrawer}>&times;</button>\r\n          </div>\r\n\r\n          {cartItems.length === 0 ? (\r\n            <p className=\"empty-message\">Your cart is empty.</p>\r\n          ) : (\r\n            <ul className=\"cart-items\">\r\n               {cartItems.map((item) => (\r\n                <li key={item.variantId} className=\"cart-item-overlay\">\r\n                  <div className=\"cart-image-full\">\r\n                    {item.image && (\r\n                      <Image\r\n                        src={item.image}\r\n                        alt={displayTitle(item.title, item.variantTitle)}\r\n                        width={600}\r\n                        height={750}\r\n                        style={{\r\n                          objectFit: 'cover',\r\n                          width: '100%',\r\n                          height: 'auto',\r\n                          display: 'block',\r\n                        }}\r\n                      />\r\n                    )}\r\n\r\n                    <div className=\"cart-image-overlay\">\r\n                      <div className=\"overlay-title\">\r\n                        {displayTitle(item.title, item.variantTitle)}\r\n                      </div>\r\n                      <div className=\"overlay-controls\">\r\n                        <div className=\"quantity-controls\">\r\n                          <button\r\n                            onClick={() =>\r\n                              updateQuantity(item.variantId, item.quantity - 1)\r\n                            }\r\n                          >\r\n                            −\r\n                          </button>\r\n                          <span>{item.quantity}</span>\r\n                          <button\r\n                            onClick={() =>\r\n                              updateQuantity(item.variantId, item.quantity + 1)\r\n                            }\r\n                          >\r\n                            +\r\n                          </button>\r\n                        </div>\r\n                        <div className=\"cart-price\">{getCurrencySymbol(item.currencyCode)}{formatPrice(getEffectivePrice(item))}</div>\r\n\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n          )}\r\n\r\n          {cartItems.length > 0 && (\r\n            <div className=\"cart-subtotal\">\r\n              Subtotal: {getCurrencySymbol(cartItems[0]?.currencyCode)}\r\n              {formatPrice(\r\n                cartItems.reduce(\r\n                  (sum, item) => sum + getEffectivePrice(item) * item.quantity,\r\n                  0\r\n                )\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          <a\r\n            className={`checkout-button ${\r\n              isCheckingOut || isDraftBuilding || (!isVipMember && !checkoutUrl)\r\n                ? 'disabled'\r\n                : ''\r\n            }`}\r\n            href={draftCheckoutUrl || checkoutUrl || '#'}\r\n            onClick={async (e) => {\r\n              e.preventDefault();\r\n              if (isCheckingOut || isDraftBuilding) return;\r\n\r\n              setIsCheckingOut(true);\r\n\r\n              try {\r\n                let urlToUse: string | null = null;\r\n\r\n                if (isVipMember) {\r\n                  if (draftCheckoutUrl && draftStatus === 'ready') {\r\n                    urlToUse = draftCheckoutUrl;\r\n                  } else {\r\n                    urlToUse = await ensureVipDraftCheckout();\r\n                  }\r\n                }\r\n\r\n                if (!urlToUse) {\r\n                  const syncedUrl = await flushSync();\r\n                  urlToUse = syncedUrl;\r\n                }\r\n\r\n                if (!urlToUse) return;\r\n\r\n                cartItems.forEach((item) => {\r\n                  if (item.handle) {\r\n                    addFavourite({\r\n                      handle: item.handle,\r\n                      title: item.title || '',\r\n                      image: item.image,\r\n                      price: item.price,\r\n                      metafields: item.metafields,\r\n                      orderAgain: true, // ✅ This sets the flag\r\n                    });\r\n                  }\r\n                });\r\n                window.location.href = urlToUse;\r\n              } finally {\r\n                setIsCheckingOut(false);\r\n              }\r\n            }}\r\n          >\r\n            {isCheckingOut || isDraftBuilding\r\n              ? 'LOADING…'\r\n              : checkoutLabel}\r\n          </a>\r\n\r\n\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}