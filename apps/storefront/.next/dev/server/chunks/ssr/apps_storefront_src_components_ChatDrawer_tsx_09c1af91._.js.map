{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/POA%20Next/apps/storefront/src/components/ChatDrawer.tsx"],"sourcesContent":["import { useChatDrawer } from '@/context/ChatDrawerContext';\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport React from 'react';\r\n\r\ninterface Message {\r\n  role: 'user' | 'assistant';\r\n  content: string;\r\n}\r\n\r\nfunction linkify(text: string): React.ReactNode[] {\r\n  const urlRegex = /(https?:\\/\\/[^\\s]+)/g;\r\n  return text.split(urlRegex).map((part, i) =>\r\n    urlRegex.test(part) ? (\r\n      <a\r\n        key={i}\r\n        href={part}\r\n        target=\"_blank\"\r\n        rel=\"noopener noreferrer\"\r\n        style={{ color: '#0070f3', textDecoration: 'underline' }}\r\n      >\r\n        {part}\r\n      </a>\r\n    ) : (\r\n      part\r\n    )\r\n  );\r\n}\r\n\r\nexport default function ChatDrawer() {\r\n  const { isDrawerOpen, closeDrawer } = useChatDrawer();\r\n  const drawerRef = useRef<HTMLDivElement>(null);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [isTyping, setIsTyping] = useState(false);\r\n  const [customerEmail, setCustomerEmail] = useState('');\r\n  const [emailCaptured, setEmailCaptured] = useState(false);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const emailSentRef = useRef(false);\r\n  const replySound = useRef<HTMLAudioElement | null>(null);\r\n  const inputRef = useRef<HTMLInputElement>(null);\r\n\r\n  useEffect(() => {\r\n    replySound.current = new Audio('/message.mp3');\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isLoading) inputRef.current?.focus();\r\n  }, [isLoading]);\r\n\r\n  const isLoggedIn = false; // Replace this later with real auth check\r\n\r\n  useEffect(() => {\r\n    const handleEscape = (e: KeyboardEvent) => {\r\n      if (e.key === 'Escape') closeDrawer();\r\n    };\r\n    if (isDrawerOpen) {\r\n      document.addEventListener('keydown', handleEscape);\r\n    }\r\n    return () => {\r\n      document.removeEventListener('keydown', handleEscape);\r\n    };\r\n  }, [isDrawerOpen, closeDrawer]);\r\n\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages, isTyping]);\r\n\r\n  // Add opening message on first open\r\n  useEffect(() => {\r\n    if (isDrawerOpen && messages.length === 0) {\r\n      setMessages([\r\n        {\r\n          role: 'assistant',\r\n          content: \"Hey, we're online. How can we help you today?\",\r\n        },\r\n      ]);\r\n    }\r\n  }, [isDrawerOpen, messages.length]);\r\n\r\n  // Send transcript after 2 mins of no new messages (kept as-is)\r\n  useEffect(() => {\r\n    if (messages.length === 0) return;\r\n\r\n    const timeout = setTimeout(() => {\r\n      if (messages.length < 2 || emailSentRef.current) return;\r\n      emailSentRef.current = true;\r\n\r\n      const formattedMessages = messages.map((msg) => ({\r\n        sender: msg.role === 'user' ? 'You' : 'PIERCE OF ART',\r\n        text: msg.content,\r\n      }));\r\n\r\n      fetch('/api/email/chat-transcript', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          email: customerEmail || 'anonymous@pierceofart.co.uk',\r\n          name: 'Customer',\r\n          messages: formattedMessages,\r\n        }),\r\n      });\r\n    }, 2 * 60 * 1000);\r\n\r\n    return () => clearTimeout(timeout);\r\n  }, [messages, customerEmail]);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!input.trim()) return;\r\n\r\n    const userMessage: Message = { role: 'user', content: input };\r\n    const updatedMessages = [...messages, userMessage];\r\n\r\n    setMessages(updatedMessages);\r\n    setInput('');\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      const res = await fetch('/api/chat', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ messages: updatedMessages }),\r\n      });\r\n\r\n      if (!res.ok) throw new Error('Network error');\r\n\r\n      const data = await res.json();\r\n      const assistantMessage: Message = {\r\n        role: 'assistant',\r\n        content: data.reply,\r\n      };\r\n\r\n      setTimeout(() => {\r\n        setIsTyping(true);\r\n\r\n        setTimeout(() => {\r\n          if (replySound.current) {\r\n            replySound.current.currentTime = 0;\r\n            replySound.current\r\n              .play()\r\n              .catch((err) => console.warn('Failed to play reply sound:', err));\r\n          }\r\n\r\n          setMessages((prev) => [...prev, assistantMessage]);\r\n          setIsTyping(false);\r\n          setIsLoading(false);\r\n        }, 6000);\r\n      }, 5000);\r\n    } catch (err) {\r\n      console.error('Chat error:', err);\r\n      setIsTyping(false);\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Simple flag: turn email capture UI on/off\r\n  const SHOW_EMAIL_CAPTURE = false; // ðŸ‘ˆ set to true later if you want it back\r\n\r\n  return (\r\n    <div\r\n      className={`cart-backdrop ${isDrawerOpen ? 'open' : ''}`}\r\n      onClick={closeDrawer}\r\n    >\r\n      <div\r\n        className={`cart-drawer ${isDrawerOpen ? 'open' : ''}`}\r\n        onClick={(e) => e.stopPropagation()}\r\n        ref={drawerRef}\r\n        role=\"dialog\"\r\n        aria-modal=\"true\"\r\n        aria-labelledby=\"chat-drawer-title\"\r\n      >\r\n        <audio\r\n          ref={replySound}\r\n          src=\"/message.mp3\"\r\n          preload=\"auto\"\r\n          style={{ display: 'none' }}\r\n        />\r\n        <div className=\"cart-drawer-inner\">\r\n          <div\r\n            className=\"cart-header\"\r\n            style={{\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between',\r\n            }}\r\n          >\r\n            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>\r\n              <h2 id=\"chat-drawer-title\" style={{ margin: 0 }}>\r\n                LIVE CHAT\r\n              </h2>\r\n              <div\r\n                className=\"ring-container\"\r\n                style={{ position: 'relative', width: '24px', height: '24px' }}\r\n              >\r\n                <div className=\"ringring\"></div>\r\n                <div className=\"circle\"></div>\r\n              </div>\r\n            </div>\r\n            <button onClick={closeDrawer} aria-label=\"Close chat\">\r\n              &times;\r\n            </button>\r\n          </div>\r\n\r\n          <div style={{ flex: 1, overflowY: 'auto', marginBottom: '16px' }}>\r\n            {messages.map((msg, i) => (\r\n  <div key={i} style={{ marginBottom: '12px' }}>\r\n\r\n    {/* Sender label ABOVE bubble */}\r\n    <div\r\n      style={{\r\n        fontSize: '12px',\r\n        fontWeight: 400,       // lighter font weight\r\n        marginBottom: '4px',\r\n        opacity: 0.6,\r\n        textAlign: msg.role === 'user' ? 'right' : 'left',\r\n      }}\r\n    >\r\n      {msg.role === 'user' ? 'ME' : 'PIERCE OF ART'}\r\n    </div>\r\n\r\n    {/* Message bubble */}\r\n    <div\r\n      style={{\r\n        background: msg.role === 'user' ? '#f0f0f0' : '#181818',\r\n        color: msg.role === 'user' ? '#181818' : '#ffffff',\r\n        padding: '10px 14px',\r\n        borderRadius: '6px',\r\n        fontSize: '14px',\r\n        lineHeight: 1.5,\r\n        whiteSpace: 'pre-wrap',\r\n        maxWidth: '85%',\r\n        marginLeft: msg.role === 'user' ? 'auto' : '0', // right-align user bubble\r\n      }}\r\n    >\r\n      {linkify(msg.content)}\r\n    </div>\r\n\r\n  </div>\r\n))}\r\n\r\n\r\n            {isTyping && (\r\n              <div\r\n                style={{\r\n                  background: '#ececec',\r\n                  padding: '8px 12px',\r\n                  borderRadius: '6px',\r\n                  marginBottom: '8px',\r\n                  fontSize: '14px',\r\n                  color: '#181818',\r\n                }}\r\n              >\r\n                <strong>PIERCE OF ART:</strong> Typingâ€¦\r\n              </div>\r\n            )}\r\n\r\n            {/* Email capture block â€“ DISABLED for now */}\r\n            {SHOW_EMAIL_CAPTURE && !isLoggedIn && !emailCaptured && (\r\n              <div\r\n                style={{\r\n                  background: '#ececec',\r\n                  padding: '12px',\r\n                  borderRadius: '6px',\r\n                  marginBottom: '12px',\r\n                  fontSize: '14px',\r\n                  color: '#181818',\r\n                }}\r\n              >\r\n                <div>\r\n                  <strong>PIERCE OF ART:</strong> Want a copy of this chat? Enter your\r\n                  email:\r\n                </div>\r\n                <form\r\n                  onSubmit={(e) => {\r\n                    e.preventDefault();\r\n                    if (customerEmail.trim()) setEmailCaptured(true);\r\n                  }}\r\n                  style={{\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    gap: '8px',\r\n                    marginTop: '8px',\r\n                  }}\r\n                >\r\n                  <input\r\n                    type=\"email\"\r\n                    value={customerEmail}\r\n                    onChange={(e) => setCustomerEmail(e.target.value)}\r\n                    placeholder=\"you@example.com\"\r\n                    required\r\n                    style={{\r\n                      flex: 1,\r\n                      padding: '10px 12px',\r\n                      fontSize: '16px',\r\n                      border: '1px solid #ccc',\r\n                      borderRadius: '4px',\r\n                    }}\r\n                  />\r\n\r\n                  <button\r\n                    type=\"submit\"\r\n                    style={{\r\n                      background: '#181818',\r\n                      color: '#fff',\r\n                      border: 'none',\r\n                      borderRadius: '4px',\r\n                      padding: '8px 16px',\r\n                      cursor: 'pointer',\r\n                    }}\r\n                  >\r\n                    &#10003;\r\n                  </button>\r\n                </form>\r\n              </div>\r\n            )}\r\n\r\n            <div ref={messagesEndRef} />\r\n          </div>\r\n\r\n          <form onSubmit={handleSubmit} style={{ display: 'flex', gap: '8px' }}>\r\n            <input\r\n              type=\"text\"\r\n              value={input}\r\n              onChange={(e) => setInput(e.target.value)}\r\n              placeholder=\"Ask us something...\"\r\n              style={{\r\n                flex: 1,\r\n                padding: '10px 12px',\r\n                fontSize: '16px',\r\n                lineHeight: 1.5,\r\n                border: '1px solid #ccc',\r\n                borderRadius: '4px',\r\n              }}\r\n              disabled={isLoading}\r\n              ref={inputRef}\r\n            />\r\n\r\n            <button\r\n              type=\"submit\"\r\n              style={{\r\n                padding: '8px 16px',\r\n                background: '#181818',\r\n                color: '#fff',\r\n                border: 'none',\r\n                borderRadius: '4px',\r\n                cursor: 'pointer',\r\n              }}\r\n              disabled={isLoading}\r\n            >\r\n              {isLoading ? '...' : 'Send'}\r\n            </button>\r\n          </form>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}